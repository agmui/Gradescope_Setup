#!/usr/bin/env bash
# Set up autograder files

#svn up /autograder/source > /dev/null #svn is no longer supported

AUTOGRADER_ROOT=/autograder
ASSIGNMENT_NAME=$(cat $AUTOGRADER_ROOT/submission_metadata.json | jq -r '.assignment.title')
declare -A assignment_dict
assignment_dict["C Review and xv6 Introduction"]=lab01-c_review
assignment_dict["Simple Shell"]=lab02-simple_shell
assignment_dict["Process Lab"]=lab03-process_lab
assignment_dict["Heap Manager"]=lab04-heap_manager
assignment_dict["(Challenge) Heap Manager II"]=lab05-heap_manager2
assignment_dict["[Challenge] Copy-on-write"]=lab06-copy_on_write
assignment_dict["Threads & Mutex Basics"]=lab07-threads_mutex_basic
assignment_dict["Condition Variables Basics"]=lab08-cond_vars_basic
assignment_dict["(Challenge) Condition Variables 2"]=lab09-cond_vars2

ASSIGNMENT=${assignment_dict[$ASSIGNMENT_NAME]}

cd /gradescope_semgrep
git pull > /dev/null
cd ..
mv /gradescope_semgrep/hw/$ASSIGNMENT/* /autograder/source

pip3 install -r /autograder/source/requirements.txt > /dev/null # each requirements.txt are hw dependent

# guarantee there is a src dir
mkdir -p /autograder/source/src
cp -r /autograder/submission/* /autograder/source/src

# shellcheck disable=SC2164
cd /autograder/source/

bash tests_setup.sh
python3 run_tests.py


#TODO: use jq
STUDENT_NAME=`grep -Po '"name":.*?",' $AUTOGRADER_ROOT/submission_metadata.json | cut -d':' -f 2 | tr -d '"' | tr -d ',' | awk '{$1=$1;print}'`
STUDENT_ID=`grep -Po '"email":.*?",' $AUTOGRADER_ROOT/submission_metadata.json | cut -d':' -f2|tr -d '"' | tr -d ',' | cut -d'@' -f1 | awk '{$1=$1;print}'`

echo "Student name is $STUDENT_NAME" # FIXME:
echo "Student ID is $STUDENT_ID"
